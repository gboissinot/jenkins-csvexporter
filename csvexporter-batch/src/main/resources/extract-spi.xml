<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xsi:schemaLocation="
        http://www.springframework.org/schema/integration
        http://www.springframework.org/schema/integration/spring-integration.xsd
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

    <!--  Spring Integration workflow -->
    <int:gateway id="processor"
                 service-interface="org.springframework.batch.item.ItemProcessor"
                 default-request-channel="jobs"
                 default-reply-channel="csvJobs" default-reply-timeout="2"/>


    <int:channel id="jobs" datatype="com.boissinot.jenkins.csvexporter.domain.InputSBJobObj"/>
    <int:channel id="csvJobs" datatype="com.boissinot.jenkins.csvexporter.domain.OutputCSVJobObj"/>

    <bean id="jobMessageBuilder" class="com.boissinot.jenkins.csvexporter.integration.JobMessageBuilder"/>
    <int:channel id="transformedJobs" datatype="java.lang.String"/>
    <int:transformer input-channel="jobs"
                     output-channel="transformedJobs"
                     ref="jobMessageBuilder"/>

    <bean id="jobMessageRouter" class="com.boissinot.jenkins.csvexporter.integration.JobMessageRouter"/>
    <int:router input-channel="transformedJobs"
                ref="jobMessageRouter"/>

    <int:channel id="matrixJobs" datatype="java.lang.String"/>
    <int:channel id="mavenJobs" datatype="java.lang.String"/>
    <int:channel id="freestyleJobs" datatype="java.lang.String"/>

    <bean id="matrixJobExtractor" class="com.boissinot.jenkins.csvexporter.service.extractor.MatrixJobExtractor"/>
    <bean id="mavenJobExtractor" class="com.boissinot.jenkins.csvexporter.service.extractor.MavenJobExtractor"/>
    <bean id="freestyleJobExtractor" class="com.boissinot.jenkins.csvexporter.service.extractor.FreestyleJobExtractor"/>

    <int:chain input-channel="matrixJobs">
        <int:header-enricher>
            <int:header name="JENKINS_JOBTYPE" value="matrixJob"/>
        </int:header-enricher>
        <int:service-activator ref="matrixJobExtractor"/>
    </int:chain>

    <int:chain input-channel="mavenJobs">
        <int:header-enricher>
            <int:header name="JENKINS_JOBTYPE" value="mavenJob"/>
        </int:header-enricher>
        <int:service-activator ref="mavenJobExtractor"/>
    </int:chain>

    <int:chain input-channel="freestyleJobs">
        <int:header-enricher>
            <int:header name="JENKINS_JOBTYPE" value="freestyleJob"/>
        </int:header-enricher>
        <int:service-activator ref="freestyleJobExtractor"/>
    </int:chain>

</beans>